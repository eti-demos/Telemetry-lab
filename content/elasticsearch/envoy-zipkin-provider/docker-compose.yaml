services:

  envoy-front-proxy:
    build:
      context: .
      dockerfile: ../shared/envoy/Dockerfile
      args:
        ENVOY_CONFIG: envoy-front-proxy.yaml
    volumes:
      - ../shared/wasm/main.wasm:/etc/wasm/main.wasm
    networks:
      - net-zipkin
    depends_on:
      zipkin:
        condition: service_healthy
      envoy-1:
        condition: service_started
      envoy-2:
        condition: service_started
    ports:
    - "${PORT_PROXY:-10000}:10000"

  envoy-1:
    build:
      context: .
      dockerfile: ../shared/envoy/Dockerfile
      args:
        ENVOY_CONFIG: envoy-1.yaml
    volumes:
      - ../shared/wasm/main.wasm:/etc/wasm/main.wasm
    networks:
      - net-zipkin
    depends_on:
      zipkin:
        condition: service_healthy
      service-1:
        condition: service_healthy
      envoy-2:
        condition: service_started

  envoy-2:
    build:
      context: .
      dockerfile: ../shared/envoy/Dockerfile
      args:
        ENVOY_CONFIG: envoy-2.yaml
    volumes:
      - ../shared/wasm/main.wasm:/etc/wasm/main.wasm
    networks:
      - net-zipkin
    depends_on:
      zipkin:
        condition: service_healthy
      service-2:
        condition: service_healthy

  service-1:
    build:
      context: ../shared/python
      target: aiohttp-tracing-service
    environment:
    - SERVICE_NAME=1
    networks:
      - net-zipkin

  service-2:
    build:
      context: ../shared/python
      target: aiohttp-tracing-service
    environment:
    - SERVICE_NAME=2
    networks:
      - net-zipkin

  jaeger: 
    image: jaegertracing/all-in-one:latest
    environment:
      - LOG_LEVEL=debug
    ports:
      - "16686:16686"
      - "4318:4318"
    command: 
      - "--collector.zipkin.host-port=9412"
    networks:
      - net-zipkin

  # zipkin:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile-zipkin
  #   ports:
  #   - "${PORT_UI:-9411}:9411"
  #   networks:
  #     - net-zipkin

networks:
  net-zipkin:
    driver: bridge 

